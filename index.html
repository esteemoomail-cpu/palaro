<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>PISO PALARO</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;600;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#060919;--card:rgba(12,17,50,.92);--card2:rgba(20,26,60,.85);--gold:#ffd700;--goldd:#c9a200;--txt:#eef;--sub:#6a73a0;--bdr:rgba(255,215,0,.1);--ok:#00e676;--gc:#007aff;--err:#ff3b3b;--warn:#ff9100;--pend:#ffab00;--r:12px}
html{scroll-behavior:smooth}
body{font-family:'Inter',system-ui,sans-serif;background:var(--bg);color:var(--txt);min-height:100vh;overflow-x:hidden}
body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse at 30% -10%,rgba(255,215,0,.06),transparent 60%),radial-gradient(ellipse at 70% 110%,rgba(0,122,255,.04),transparent 55%);pointer-events:none}
.w{max-width:860px;margin:0 auto;padding:14px;position:relative;z-index:1}
header{text-align:center;padding:30px 0 8px}
.logo{font-size:clamp(2rem,7vw,3.3rem);font-weight:900;background:linear-gradient(135deg,var(--goldd),var(--gold),#fff8c4,var(--gold));-webkit-background-clip:text;-webkit-text-fill-color:transparent;letter-spacing:4px}
.logo span{display:block;font-size:.38em;letter-spacing:12px;font-weight:300;-webkit-text-fill-color:var(--sub)}
.tag{color:var(--sub);font-size:.85rem;margin-top:4px;letter-spacing:1px}
.pill{display:inline-block;margin-top:12px;padding:7px 24px;background:linear-gradient(135deg,var(--goldd),var(--gold));color:#000;border-radius:50px;font-weight:800;font-size:.95rem}
.range{margin-top:6px;color:var(--sub);font-size:.75rem;font-family:'JetBrains Mono',monospace;letter-spacing:2px}
.draw-banner{background:linear-gradient(135deg,rgba(255,215,0,.1),rgba(255,215,0,.03));border:1px solid rgba(255,215,0,.15);border-radius:var(--r);padding:12px 18px;margin:14px 0;text-align:center;display:none}
.draw-banner .db-label{font-size:.65rem;color:var(--sub);text-transform:uppercase;letter-spacing:2px;margin-bottom:2px}
.draw-banner .db-date{font-size:1.1rem;font-weight:800;color:var(--gold);font-family:'JetBrains Mono',monospace}
.announce-banner{background:linear-gradient(135deg,rgba(0,122,255,.1),rgba(0,122,255,.03));border:1px solid rgba(0,122,255,.18);border-radius:var(--r);padding:14px 18px;margin:14px 0;display:none;line-height:1.7;font-size:.88rem}
.maint-overlay{display:none;position:fixed;inset:0;background:rgba(6,9,25,.97);z-index:9998;justify-content:center;align-items:center;flex-direction:column;text-align:center;padding:20px}
.maint-overlay.on{display:flex}
.maint-overlay .mi{font-size:4rem;margin-bottom:16px}
.maint-overlay h2{color:var(--gold);font-size:1.5rem;margin-bottom:8px}
.maint-overlay p{color:var(--sub);font-size:.92rem;max-width:400px;line-height:1.8}
.info-bar{background:var(--card);border:1px solid var(--bdr);border-radius:16px;padding:20px 24px;backdrop-filter:blur(10px);margin:22px 0}
.info-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:10px}
.date-box{display:flex;align-items:center;gap:10px}
.date-icon{width:42px;height:42px;background:linear-gradient(135deg,rgba(255,215,0,.12),rgba(255,215,0,.04));border:1px solid rgba(255,215,0,.15);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.2rem}
.date-label{font-size:.65rem;color:var(--sub);text-transform:uppercase;letter-spacing:2px;margin-bottom:2px}
.date-value{font-size:1.05rem;font-weight:700;font-family:'JetBrains Mono',monospace;color:var(--gold)}
.avail-label{font-size:.65rem;color:var(--sub);text-transform:uppercase;letter-spacing:2px;text-align:right}
.avail-status{font-size:.82rem;font-weight:600;margin-top:2px;text-align:right}
.avail-status.high{color:var(--ok)}.avail-status.mid{color:var(--warn)}.avail-status.low{color:var(--err)}
.progress-wrap{position:relative}
.progress-track{width:100%;height:14px;background:rgba(255,255,255,.06);border-radius:10px;overflow:hidden;border:1px solid rgba(255,255,255,.05)}
.progress-fill{height:100%;border-radius:10px;background:linear-gradient(90deg,var(--ok),#69f0ae);transition:width 1.5s;position:relative}
.progress-fill.mid{background:linear-gradient(90deg,var(--warn),#ffcc02)}
.progress-fill.low{background:linear-gradient(90deg,var(--err),#ff6b6b)}
.progress-fill::after{content:'';position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,.15),transparent);animation:shimmer 2s infinite}
@keyframes shimmer{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}
.progress-dots{display:flex;justify-content:space-between;margin-top:6px;padding:0 2px}
.progress-dots span{width:1px;height:6px;background:rgba(255,255,255,.1)}
.conn{display:flex;align-items:center;justify-content:center;gap:8px;margin:16px 0 8px;padding:10px;border-radius:var(--r);font-size:.8rem;font-weight:600;transition:.3s}
.conn.checking{background:rgba(255,255,255,.05);color:var(--sub);border:1px solid rgba(255,255,255,.08)}
.conn.online{background:rgba(0,230,118,.08);color:var(--ok);border:1px solid rgba(0,230,118,.15)}
.conn.offline{background:rgba(255,59,59,.08);color:var(--err);border:1px solid rgba(255,59,59,.15)}
.conn .dot{width:8px;height:8px;border-radius:50%}
.conn.checking .dot{background:var(--sub);animation:pulse 1s infinite}
.conn.online .dot{background:var(--ok)}
.conn.offline .dot{background:var(--err)}
@keyframes pulse{0%,100%{opacity:.3}50%{opacity:1}}
.card{background:var(--card);border:1px solid var(--bdr);border-radius:16px;padding:24px;backdrop-filter:blur(10px);margin-bottom:22px}
.steps{display:flex;justify-content:center;align-items:center;margin-bottom:22px}
.stp{display:flex;align-items:center;gap:5px;padding:7px 10px;font-size:.76rem;font-weight:600;color:var(--sub);transition:.3s}
.stp .n{width:25px;height:25px;border-radius:50%;background:rgba(255,255,255,.07);display:flex;align-items:center;justify-content:center;font-size:.73rem;font-weight:700;transition:.3s}
.stp.on{color:var(--gold)}.stp.on .n{background:var(--gold);color:#000}
.stp.ok{color:var(--ok)}.stp.ok .n{background:var(--ok);color:#fff}
.sln{width:28px;height:2px;background:rgba(255,255,255,.07);transition:.3s}.sln.on{background:var(--gold)}
.ct{font-size:1.05rem;font-weight:700;margin-bottom:18px;display:flex;align-items:center;gap:7px}
.fg{margin-bottom:14px}
.fg label{display:block;font-size:.7rem;font-weight:600;color:var(--sub);margin-bottom:5px;text-transform:uppercase;letter-spacing:2px}
.fg input,.fg textarea,.fg select{width:100%;padding:12px 13px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);border-radius:10px;color:#fff;font-size:1rem;font-family:inherit;outline:none;transition:.3s}
.fg input:focus,.fg textarea:focus,.fg select:focus{border-color:var(--gold);box-shadow:0 0 0 3px rgba(255,215,0,.08)}
.fg input::placeholder{color:rgba(255,255,255,.18)}
.fg .field-err{color:var(--err);font-size:.7rem;margin-top:4px;display:none}
.fg .field-ok{color:var(--ok);font-size:.7rem;margin-top:4px;display:none}
.fr{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.tot{background:linear-gradient(135deg,rgba(255,215,0,.08),rgba(255,215,0,.02));border:1px dashed rgba(255,215,0,.2);border-radius:var(--r);padding:14px;text-align:center;margin:14px 0}
.tot .tl{font-size:.66rem;color:var(--sub);text-transform:uppercase;letter-spacing:2px;margin-bottom:3px}
.tot .tv{font-size:1.9rem;font-weight:900;color:var(--gold);font-family:'JetBrains Mono',monospace}
.gc{background:linear-gradient(135deg,rgba(0,122,255,.1),rgba(0,122,255,.03));border:1px solid rgba(0,122,255,.18);border-radius:var(--r);padding:18px;margin:14px 0}
.gc-h{display:flex;align-items:center;gap:7px;margin-bottom:10px;font-weight:700}
.gc-b{background:var(--gc);color:#fff;padding:4px 11px;border-radius:6px;font-weight:800;font-size:.8rem}
.gc-num{font-family:'JetBrains Mono',monospace;font-size:1.2rem;font-weight:700;color:#64b5f6;background:rgba(0,122,255,.12);padding:9px 16px;border-radius:8px;display:inline-block;margin:5px 0;cursor:pointer;user-select:all;border:1px dashed rgba(100,181,246,.3);transition:.2s}
.gc-num:hover{background:rgba(0,122,255,.2)}
.btn{width:100%;padding:13px;border:none;border-radius:var(--r);font-size:.9rem;font-weight:700;font-family:inherit;cursor:pointer;transition:.25s;text-transform:uppercase;letter-spacing:2px}
.b1{background:linear-gradient(135deg,var(--goldd),var(--gold));color:#000;box-shadow:0 4px 24px rgba(255,215,0,.2)}
.b1:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 6px 32px rgba(255,215,0,.3)}
.b1:disabled{opacity:.4;cursor:not-allowed}
.b2{background:rgba(255,255,255,.06);color:#fff;border:1px solid rgba(255,255,255,.1);margin-top:10px}
.b2:hover{background:rgba(255,255,255,.1)}
.receipt{background:var(--card);border:1px solid var(--bdr);border-radius:16px;padding:24px;backdrop-filter:blur(10px)}
.rh{text-align:center;padding-bottom:16px;border-bottom:1px dashed var(--bdr);margin-bottom:14px}
.rh .ic{width:56px;height:56px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.7rem;margin:0 auto 10px;animation:pop .4s}
@keyframes pop{0%{transform:scale(0) rotate(-20deg)}60%{transform:scale(1.15) rotate(5deg)}100%{transform:scale(1)}}
.rd{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:14px;padding-bottom:14px;border-bottom:1px dashed var(--bdr)}
.ri .rl{color:var(--sub);font-size:.63rem;text-transform:uppercase;letter-spacing:1.5px}
.ri .rv{font-weight:600;margin-top:2px;font-size:.88rem;word-break:break-all}
.ubadge{display:inline-flex;align-items:center;gap:4px;padding:4px 13px;border-radius:20px;font-size:.7rem;font-weight:700;letter-spacing:1px;margin:8px auto;text-transform:uppercase}
.ubadge.pending{background:rgba(255,171,0,.1);border:1px solid rgba(255,171,0,.2);color:var(--pend)}
.nt{font-weight:700;font-size:.95rem;margin-bottom:8px;display:flex;align-items:center;gap:6px}
.nbox{max-height:480px;overflow-y:auto;padding:11px;background:rgba(0,0,0,.4);border-radius:10px;border:1px solid rgba(255,215,0,.06);margin:6px 0}
.ngrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(98px,1fr));gap:4px}
.ni{font-family:'JetBrains Mono',monospace;font-size:.88rem;font-weight:700;padding:7px 3px;background:linear-gradient(135deg,rgba(255,215,0,.06),rgba(255,215,0,.02));border:1px solid rgba(255,215,0,.1);border-radius:6px;text-align:center;color:var(--gold);letter-spacing:3px}
.acts{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:14px}
.acts .btn{padding:9px;font-size:.7rem;letter-spacing:1.5px}
.ov{display:none;position:fixed;inset:0;background:rgba(6,9,25,.95);z-index:9999;justify-content:center;align-items:center;flex-direction:column;text-align:center;padding:20px}
.ov.on{display:flex}
.sp{width:50px;height:50px;border:4px solid rgba(255,215,0,.12);border-top-color:var(--gold);border-radius:50%;animation:spin .7s linear infinite;margin-bottom:14px}
@keyframes spin{to{transform:rotate(360deg)}}
.ov-t{color:var(--gold);font-weight:600;font-size:.9rem;letter-spacing:1px;line-height:1.8}
.ov-s{color:var(--sub);font-size:.78rem;margin-top:6px;line-height:1.6}
.toast{position:fixed;top:14px;right:14px;padding:12px 20px;border-radius:10px;font-weight:600;font-size:.85rem;z-index:10001;transform:translateX(150%);transition:transform .3s;max-width:400px;line-height:1.5}
.toast.on{transform:translateX(0)}
.toast.err{background:var(--err);color:#fff}
.toast.suc{background:var(--ok);color:#000}
.toast.warn{background:var(--warn);color:#000}
.hide{display:none!important}
.err-panel{background:linear-gradient(135deg,rgba(255,59,59,.1),rgba(255,59,59,.03));border:1px solid rgba(255,59,59,.2);border-radius:var(--r);padding:18px;margin:14px 0;line-height:1.8;font-size:.85rem}
.err-panel h3{color:var(--err);margin-bottom:8px}
.err-panel .retry-btn{display:inline-block;margin-top:10px;padding:8px 20px;background:var(--err);color:#fff;border:none;border-radius:8px;font-weight:700;cursor:pointer;font-family:inherit}
footer{text-align:center;padding:24px 0;color:var(--sub);font-size:.68rem;line-height:2}
.pending-notice{background:linear-gradient(135deg,rgba(255,171,0,.1),rgba(255,171,0,.03));border:1px solid rgba(255,171,0,.2);border-radius:var(--r);padding:14px 18px;margin:12px 0;line-height:1.7;font-size:.85rem;color:var(--pend)}
.ref-row{margin:6px 0;padding:10px 0}
.ref-label{font-size:.68rem;color:var(--sub);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:5px}
.ref-val-wrap{display:flex;align-items:center;gap:10px}
.ref-val{font-family:'JetBrains Mono',monospace;font-size:.95rem;font-weight:700;color:var(--txt);word-break:break-all;flex:1}
.copy-btn{flex-shrink:0;padding:5px 12px;background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.12);border-radius:6px;color:var(--sub);font-size:.72rem;font-weight:600;cursor:pointer;font-family:inherit;transition:.2s;text-transform:uppercase;letter-spacing:1px}
.copy-btn:hover{background:rgba(255,255,255,.13);color:var(--txt)}
.qp-wrap{margin-bottom:14px}
.qp-label{font-size:.7rem;font-weight:600;color:var(--sub);text-transform:uppercase;letter-spacing:2px;margin-bottom:8px;display:flex;align-items:center;justify-content:space-between}
.qp-label .qp-reset{font-size:.65rem;color:var(--sub);cursor:pointer;text-transform:none;letter-spacing:0;padding:2px 8px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:4px;font-weight:500;transition:.2s}
.qp-label .qp-reset:hover{color:var(--err);border-color:rgba(255,59,59,.3)}
.qp-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:6px}
.qp-btn{padding:9px 4px;background:rgba(255,215,0,.06);border:1px solid rgba(255,215,0,.15);border-radius:9px;color:var(--gold);font-size:.78rem;font-weight:700;cursor:pointer;font-family:inherit;transition:.2s;text-align:center;line-height:1.3}
.qp-btn:hover{background:rgba(255,215,0,.14);border-color:rgba(255,215,0,.35);transform:translateY(-1px)}
.qp-btn:active{transform:translateY(0)}
.qp-btn.max-btn{background:linear-gradient(135deg,rgba(255,215,0,.15),rgba(255,215,0,.06));border-color:rgba(255,215,0,.3)}
.qp-added{background:rgba(0,230,118,.1)!important;border-color:rgba(0,230,118,.35)!important;color:var(--ok)!important;animation:qpFlash .35s ease}
@keyframes qpFlash{0%{transform:scale(1.08)}60%{transform:scale(.97)}100%{transform:scale(1)}}
.search-loading{display:none;align-items:center;gap:8px;color:var(--sub);font-size:.8rem;padding:8px 0}
.search-loading.on{display:flex}
.search-loading .sp-sm{width:16px;height:16px;border:2px solid rgba(255,215,0,.15);border-top-color:var(--gold);border-radius:50%;animation:spin .6s linear infinite}
.pool-info{font-size:.72rem;color:var(--sub);text-align:center;margin-top:4px;font-family:'JetBrains Mono',monospace;letter-spacing:1px}
.login-wrap{display:flex;align-items:center;justify-content:center;min-height:100vh;padding:20px}
.login-box{background:var(--card);border:1px solid var(--bdr);border-radius:20px;padding:40px 32px;width:100%;max-width:420px;backdrop-filter:blur(10px);text-align:center}
.login-box h1{font-size:1.6rem;margin-bottom:4px;background:linear-gradient(135deg,var(--goldd),var(--gold));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.login-box .lsub{color:var(--sub);font-size:.82rem;margin-bottom:28px}
.admin{display:none;min-height:100vh}
.topbar{background:var(--card);border-bottom:1px solid var(--bdr);padding:12px 24px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100;backdrop-filter:blur(10px)}
.topbar h1{font-size:1.1rem;min-width:0;background:linear-gradient(135deg,var(--goldd),var(--gold));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.topbar .user{display:flex;align-items:center;gap:10px;font-size:.82rem;color:var(--sub)}
.topbar .logout{padding:6px 14px;background:rgba(255,59,59,.1);border:1px solid rgba(255,59,59,.2);color:var(--err);border-radius:8px;font-size:.75rem;font-weight:700;cursor:pointer;font-family:inherit;text-transform:uppercase;letter-spacing:1px}
.mob-nav{display:none}
.admain{display:flex;min-height:calc(100vh - 56px)}
.sidebar{width:220px;background:var(--card);border-right:1px solid var(--bdr);padding:16px 0;flex-shrink:0;position:sticky;top:56px;height:calc(100vh - 56px);overflow-y:auto}
.nav-item{display:flex;align-items:center;gap:10px;padding:11px 20px;font-size:.82rem;font-weight:500;color:var(--sub);cursor:pointer;transition:.2s;border-left:3px solid transparent}
.nav-item:hover{background:rgba(255,215,0,.04);color:var(--txt)}
.nav-item.active{background:rgba(255,215,0,.06);color:var(--gold);border-left-color:var(--gold);font-weight:700}
.nav-sep{height:1px;background:var(--bdr);margin:10px 16px}
.content{flex:1;padding:24px;overflow-y:auto}
.page{display:none}.page.active{display:block}
.page-title{font-size:1.4rem;font-weight:800;margin-bottom:6px}
.page-sub{color:var(--sub);font-size:.82rem;margin-bottom:24px}
.stats{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:14px;margin-bottom:24px}
.stat{background:var(--card2);border:1px solid var(--bdr);border-radius:14px;padding:18px;transition:.2s}
.stat:hover{border-color:rgba(255,215,0,.2);transform:translateY(-1px)}
.stat .sl{font-size:.65rem;color:var(--sub);text-transform:uppercase;letter-spacing:2px;margin-bottom:6px}
.stat .sv{font-size:1.6rem;font-weight:800;font-family:'JetBrains Mono',monospace}
.stat .sc{font-size:.7rem;margin-top:4px}
.stat.gold .sv{color:var(--gold)}.stat.green .sv{color:var(--ok)}.stat.blue .sv{color:var(--gc)}.stat.red .sv{color:var(--err)}.stat.yellow .sv{color:var(--pend)}
.tbl-wrap{background:var(--card2);border:1px solid var(--bdr);border-radius:14px;overflow:hidden;margin-bottom:20px}
.tbl-head{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid var(--bdr);flex-wrap:wrap;gap:10px}
.tbl-head h3{font-size:.95rem}
.tbl-actions{display:flex;gap:8px;flex-wrap:wrap}
.btn-sm{padding:7px 14px;border:none;border-radius:8px;font-size:.75rem;font-weight:700;cursor:pointer;font-family:inherit;transition:.2s;text-transform:uppercase;letter-spacing:1px}
.btn-gold{background:linear-gradient(135deg,var(--goldd),var(--gold));color:#000}
.btn-blue{background:rgba(0,122,255,.15);border:1px solid rgba(0,122,255,.2);color:#64b5f6}
.btn-red{background:rgba(255,59,59,.12);border:1px solid rgba(255,59,59,.2);color:var(--err)}
.btn-green{background:rgba(0,230,118,.12);border:1px solid rgba(0,230,118,.2);color:var(--ok)}
.btn-orange{background:rgba(255,145,0,.12);border:1px solid rgba(255,145,0,.2);color:var(--warn)}
table{width:100%;border-collapse:collapse}
th{padding:10px 14px;text-align:left;font-size:.68rem;text-transform:uppercase;letter-spacing:2px;color:var(--sub);border-bottom:1px solid var(--bdr);background:rgba(0,0,0,.2);white-space:nowrap}
td{padding:10px 14px;border-bottom:1px solid rgba(255,255,255,.03);font-size:.82rem;white-space:nowrap}
tr:hover td{background:rgba(255,215,0,.02)}
.badge{display:inline-block;padding:3px 10px;border-radius:20px;font-size:.68rem;font-weight:700;text-transform:uppercase;letter-spacing:1px}
.badge.ok{background:rgba(0,230,118,.1);color:var(--ok)}
.badge.pend{background:rgba(255,171,0,.1);color:var(--pend)}
.badge.fail,.badge.dec{background:rgba(255,59,59,.1);color:var(--err)}
.mono{font-family:'JetBrains Mono',monospace;letter-spacing:2px;color:var(--gold)}
.tbl-empty{padding:40px;text-align:center;color:var(--sub);font-size:.88rem}
.pagination{display:flex;align-items:center;justify-content:center;gap:8px;padding:14px;border-top:1px solid var(--bdr)}
.pg-btn{padding:6px 12px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);border-radius:6px;color:var(--txt);font-size:.78rem;cursor:pointer;font-family:inherit}
.pg-btn:disabled{opacity:.3;cursor:not-allowed}
.pg-btn.active{background:var(--gold);color:#000;font-weight:700}
.pg-info{font-size:.75rem;color:var(--sub)}
.settings-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.setting-group{background:var(--card2);border:1px solid var(--bdr);border-radius:14px;padding:20px;margin-bottom:16px}
.setting-group h3{font-size:.9rem;margin-bottom:14px;display:flex;align-items:center;gap:8px}
.fg textarea{resize:vertical;min-height:80px}
.fg select{appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%236a73a0'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center}
.tool-card{background:var(--card2);border:1px solid var(--bdr);border-radius:14px;padding:20px;margin-bottom:16px}
.tool-card h3{font-size:.9rem;margin-bottom:12px;display:flex;align-items:center;gap:8px}
.tool-row{display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap}
.tool-row .fg{flex:1;min-width:160px;margin-bottom:0}
.bar-track{width:100%;height:8px;background:rgba(255,255,255,.06);border-radius:6px;overflow:hidden;margin-top:8px}
.bar-fill{height:100%;border-radius:6px;transition:width 1s;background:linear-gradient(90deg,var(--ok),#69f0ae)}
.bar-fill.mid{background:linear-gradient(90deg,var(--warn),#ffcc02)}
.bar-fill.low{background:linear-gradient(90deg,var(--err),#ff6b6b)}
.feed{list-style:none}
.feed li{padding:10px 14px;border-bottom:1px solid rgba(255,255,255,.03);display:flex;align-items:center;gap:12px;font-size:.82rem}
.feed li:last-child{border-bottom:none}
.feed .dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.feed .dot.ok{background:var(--ok)}.feed .dot.pend{background:var(--pend)}.feed .dot.fail,.feed .dot.dec{background:var(--err)}
.feed .time{color:var(--sub);font-size:.7rem;font-family:'JetBrains Mono',monospace;white-space:nowrap}
.confirm-modal{display:none;position:fixed;inset:0;background:rgba(6,9,25,.92);z-index:10000;justify-content:center;align-items:center;padding:20px;overflow-y:auto}
.confirm-modal.on{display:flex}
.confirm-box{background:var(--card);border:1px solid var(--bdr);border-radius:16px;padding:28px;max-width:420px;width:100%;text-align:center}
.confirm-box h3{margin-bottom:8px}
.confirm-box p{color:var(--sub);font-size:.85rem;margin-bottom:20px;line-height:1.7}
.confirm-box code{background:rgba(0,0,0,.4);padding:2px 8px;border-radius:4px;font-family:'JetBrains Mono',monospace;color:var(--gold)}
.confirm-btns{display:flex;gap:10px;justify-content:center}
.confirm-btns .btn-sm{padding:10px 24px;font-size:.8rem}
.detail-modal{display:none;position:fixed;inset:0;background:rgba(6,9,25,.94);z-index:10000;justify-content:center;align-items:flex-start;padding:30px 20px;overflow-y:auto}
.detail-modal.on{display:flex}
.detail-box{background:var(--card);border:1px solid var(--bdr);border-radius:16px;padding:28px;max-width:700px;width:100%;margin:auto}
.detail-box h2{font-size:1.2rem;margin-bottom:4px;display:flex;align-items:center;gap:8px}
.detail-sub{color:var(--sub);font-size:.78rem;margin-bottom:18px}
.detail-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:18px;padding-bottom:18px;border-bottom:1px dashed var(--bdr)}
.detail-grid .ri .rl{color:var(--sub);font-size:.63rem;text-transform:uppercase;letter-spacing:1.5px}
.detail-grid .ri .rv{font-weight:600;margin-top:2px;font-size:.88rem;word-break:break-all}
.detail-nums{margin:14px 0}
.detail-nums h3{font-size:.9rem;margin-bottom:8px;display:flex;align-items:center;gap:6px}
.detail-actions{display:flex;gap:8px;margin-top:18px;padding-top:18px;border-top:1px dashed var(--bdr);flex-wrap:wrap;justify-content:center}
.clickable-row{cursor:pointer;transition:.2s}
.clickable-row:hover td{background:rgba(255,215,0,.06)!important}
.tx-actions{display:flex;gap:4px;flex-wrap:wrap}
.pub-link{display:block;margin-top:20px;color:var(--gc);font-size:.82rem;font-weight:600;text-decoration:none;transition:.2s}
.pub-link:hover{color:var(--gold)}
.pub-link-btn{display:inline-flex;align-items:center;gap:6px;padding:8px 18px;background:rgba(0,122,255,.1);border:1px solid rgba(0,122,255,.2);color:#64b5f6;border-radius:10px;font-size:.78rem;font-weight:700;text-decoration:none;transition:.2s;white-space:nowrap}
.pub-link-btn:hover{background:rgba(0,122,255,.2);color:#fff;transform:translateY(-1px)}
::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:rgba(255,255,255,.02)}::-webkit-scrollbar-thumb{background:rgba(255,215,0,.15);border-radius:3px}

@media(max-width:500px){
  .qp-grid{grid-template-columns:repeat(3,1fr)}
  .info-bar{padding:16px}
  .info-top{flex-direction:column;align-items:flex-start;gap:12px}
  .avail-label,.avail-status{text-align:left}
  .fr{grid-template-columns:1fr}
  .card{padding:16px}
  .ngrid{grid-template-columns:repeat(auto-fill,minmax(82px,1fr))}
  .acts{grid-template-columns:1fr}
  .rd{grid-template-columns:1fr}
  .detail-grid{grid-template-columns:1fr}
  .stp .stx{display:none}
  .stp{padding:7px 6px}
}
@media(max-width:768px){
  .sidebar{display:none}
  .admain{flex-direction:column}
  .content{padding:12px;overflow-x:hidden}
  .stats{grid-template-columns:repeat(2,1fr)}
  .stats>.stat:last-child:nth-child(odd){grid-column:span 2}
  .stat{padding:14px}.stat .sv{font-size:1.3rem}
  .settings-grid{grid-template-columns:1fr}
  .tbl-head{flex-direction:column;align-items:stretch;padding:10px 12px}
  .tbl-head h3{font-size:.85rem}
  .tbl-actions{flex-wrap:wrap;gap:6px}
  table{font-size:.73rem}
  th{padding:7px 8px;font-size:.6rem;letter-spacing:1px}
  td{padding:7px 8px;white-space:normal;vertical-align:top}
  td.mono,td:nth-child(2){white-space:nowrap}
  .tx-actions{flex-wrap:nowrap;gap:3px}
  .tx-actions .btn-sm{padding:5px 7px;font-size:.63rem;letter-spacing:0}
  .feed li{flex-wrap:wrap;gap:6px;padding:9px 12px}
  .feed .time{white-space:normal;word-break:break-all;font-size:.65rem}
  .topbar{padding:10px 14px}
  .topbar h1{font-size:.88rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:180px}
  .topbar .user{gap:6px;font-size:.75rem}
  .topbar .logout{padding:5px 10px;font-size:.7rem;letter-spacing:0}
  .mob-nav{display:flex!important;position:sticky;top:0;z-index:99;overflow-x:auto;gap:0;padding:0;background:var(--card);border-bottom:1px solid var(--bdr);scrollbar-width:none}
  .mob-nav::-webkit-scrollbar{display:none}
  .mob-nav .nav-item{border-left:none;border-bottom:3px solid transparent;white-space:nowrap;padding:10px 13px;font-size:.72rem;flex-shrink:0}
  .mob-nav .nav-item.active{border-bottom-color:var(--gold);background:rgba(255,215,0,.05)}
  .tool-row{flex-direction:column}.tool-row .fg{min-width:100%}
  .detail-box{padding:16px;margin:0}
  .detail-modal{padding:12px 8px}
  .page-title{font-size:1.15rem}
  .page-sub{font-size:.75rem;margin-bottom:16px}
}
@media(min-width:769px){.mob-nav{display:none!important}}
</style>
</head>
<body>

<div class="ov" id="ov"><div class="sp"></div><div class="ov-t" id="ovT"></div><div class="ov-s" id="ovS"></div></div>
<div class="toast" id="toast"></div>
<div class="confirm-modal" id="confirmModal"><div class="confirm-box"><h3 id="confirmTitle"></h3><p id="confirmMsg"></p><div class="confirm-btns"><button class="btn-sm btn-red" id="confirmYes">Yes</button><button class="btn-sm btn-blue" onclick="closeConfirm()">Cancel</button></div></div></div>
<div class="detail-modal" id="detailModal"><div class="detail-box"><div style="display:flex;justify-content:space-between;align-items:flex-start"><div><h2 id="detailTitle">ğŸ“‹ Transaction Detail</h2><div class="detail-sub" id="detailSub"></div></div><button class="btn-sm btn-blue" onclick="closeDetail()" style="flex-shrink:0">âœ• Close</button></div><div class="detail-grid" id="detailGrid"></div><div class="detail-nums" id="detailNums"></div><div class="detail-actions" id="detailActions"></div></div></div>
<div class="maint-overlay" id="maintOverlay"><div class="mi">ğŸ”§</div><h2>Under Maintenance</h2><p>Purchases temporarily paused.</p></div>

<!-- PUBLIC PAGE -->
<div id="publicPage">
<div class="w">
<header>
  <div class="logo" id="logoText">ğŸ° PISO<span>PALARO</span></div>
  <p class="tag" id="tagLine">Get your lucky numbers â€” only â‚±1 each!</p>
  <div class="pill" id="priceTag">â‚±1.00 PER ENTRY</div>
  <div class="pool-info">Pool: 000000 â€“ 199999 (200,000 numbers)</div>
</header>
<div class="draw-banner" id="drawBanner"><div class="db-label">ğŸ¯ Draw Date</div><div class="db-date" id="drawDateText"></div></div>
<div class="announce-banner" id="announceBanner"><span style="font-size:1.2rem;margin-right:6px">ğŸ“¢</span><span id="announceText"></span></div>
<div class="conn checking" id="connBar"><div class="dot"></div><span id="connTxt">Connecting...</span></div>
<div id="errPanel" class="err-panel hide"><h3>âš ï¸ Connection Failed</h3><div id="errDetail"></div></div>
<div class="info-bar">
  <div class="info-top">
    <div class="date-box"><div class="date-icon">ğŸ“…</div><div><div class="date-label">Today</div><div class="date-value" id="dateToday">â€”</div></div></div>
    <div><div class="avail-label">Availability</div><div class="avail-status high" id="availTxt">Loading...</div></div>
  </div>
  <div class="progress-wrap"><div class="progress-track"><div class="progress-fill" id="progressFill" style="width:100%"></div></div><div class="progress-dots"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></div></div>
</div>

<div id="secB">
<div class="card">
  <div class="steps">
    <div class="stp on" id="i1"><div class="n">1</div><span class="stx">Details</span></div>
    <div class="sln" id="l1"></div>
    <div class="stp" id="i2"><div class="n">2</div><span class="stx">Payment</span></div>
    <div class="sln" id="l2"></div>
    <div class="stp" id="i3"><div class="n">3</div><span class="stx">Complete</span></div>
  </div>

  <div id="p1">
    <div class="ct">ğŸ“ Your Details</div>
    <div class="fr">
      <div class="fg"><label>Full Name</label><input id="fN" placeholder="e.g. Juan Dela Cruz" autocomplete="name" maxlength="40"></div>
      <div class="fg"><label>Phone <span style="font-weight:400;text-transform:none;color:var(--sub)">(11 digits)</span></label><input id="fP" type="tel" maxlength="11" placeholder="09171234567" autocomplete="tel"><div class="field-err" id="phoneErr"></div><div class="field-ok" id="phoneOk">âœ“ Valid</div></div>
    </div>
    <div class="qp-wrap">
      <div class="qp-label">Quick Pick <span class="qp-reset" onclick="resetQty()">âœ• Reset</span></div>
      <div class="qp-grid">
        <button class="qp-btn" onclick="addQty(100,this)">+100</button>
        <button class="qp-btn" onclick="addQty(200,this)">+200</button>
        <button class="qp-btn" onclick="addQty(500,this)">+500</button>
        <button class="qp-btn" onclick="addQty(1000,this)">+1,000</button>
        <button class="qp-btn" onclick="addQty(5000,this)">+5,000</button>
        <button class="qp-btn max-btn" onclick="setMaxQtyFn()">MAX</button>
      </div>
    </div>
    <div class="fg"><label id="qtyLabel">Total Quantity <span style="font-weight:400;text-transform:none;color:var(--sub)">(min <span id="minQtySpan">100</span>)</span></label><input id="fQ" type="number" min="100" max="10000" placeholder="Or type manually"></div>
    <div class="tot"><div class="tl">Total</div><div class="tv" id="dT">â‚± 0.00</div></div>
    <button class="btn b1" onclick="go2()">Continue to Payment â†’</button>
  </div>

  <div id="p2" class="hide">
    <div class="ct">ğŸ’³ GCash Payment</div>
    <div class="gc">
      <div class="gc-h"><div class="gc-b">GCash</div> Send To:</div>
      <div style="line-height:2.2">
        <strong>Name:</strong> <span id="dN"></span><br>
        <strong>Number:</strong><br><div class="gc-num" id="dP" onclick="cpGC()" title="Tap to copy"></div><br>
        <strong>Amount:</strong> <span style="color:var(--gold);font-weight:800;font-size:1.1rem" id="dA"></span>
      </div>
      <div style="margin-top:14px;padding:12px 14px;background:rgba(0,122,255,.07);border:1px solid rgba(0,122,255,.15);border-radius:10px;font-size:.82rem;line-height:1.7;color:#a8c8f8">
        <div>ğŸ“‹ After sending, enter the GCash reference number below.</div>
        <div style="margin-top:6px;color:var(--warn)">ğŸ“¸ <strong>Take a screenshot of your GCash payment as backup proof.</strong></div>
      </div>
    </div>
    <div class="fg"><label>GCash Reference # <span style="font-weight:400;text-transform:none;color:var(--sub)">(digits only, max 13)</span></label><input id="fR" placeholder="Enter ref from receipt" autocomplete="off" maxlength="13" inputmode="numeric"></div>
    <button class="btn b1" id="buyBtn" onclick="submitPurchase()">âœ“ Confirm Entry</button>
    <button class="btn b2" onclick="go1()">â† Back</button>
  </div>
</div>
</div>

<div id="secR" class="hide">
<div class="receipt">
  <div class="rh">
    <div class="ic" style="background:var(--pend)">â³</div>
    <h2 style="font-size:1.3rem;margin-bottom:3px">Entry Submitted!</h2>
    <p style="color:var(--sub);font-size:.83rem">Your numbers are reserved and pending approval.</p>
    <div class="ubadge pending">â³ Pending Approval</div>
  </div>
  <div class="pending-notice">â³ <strong>Your entry is pending admin approval.</strong> Save your Transaction ID and GCash Reference below.</div>
  <div class="ref-row"><div class="ref-label">ğŸ“Œ Transaction ID</div><div class="ref-val-wrap"><span class="ref-val" id="rI"></span><button class="copy-btn" onclick="cpField('rI')">Copy</button></div></div>
  <div class="ref-row" style="margin-bottom:14px"><div class="ref-label">ğŸ’³ GCash Reference #</div><div class="ref-val-wrap"><span class="ref-val" id="rR"></span><button class="copy-btn" onclick="cpField('rR')">Copy</button></div></div>
  <div class="rd">
    <div class="ri"><div class="rl">Timestamp</div><div class="rv" id="rD"></div></div>
    <div class="ri"><div class="rl">Name</div><div class="rv" id="rN"></div></div>
    <div class="ri"><div class="rl">Phone</div><div class="rv" id="rP"></div></div>
    <div class="ri"><div class="rl">Quantity</div><div class="rv" id="rQ"></div></div>
    <div class="ri"><div class="rl">Amount</div><div class="rv" style="color:var(--gold)" id="rA"></div></div>
    <div class="ri"><div class="rl">Status</div><div class="rv" style="color:var(--pend);font-weight:800" id="rS">â³ PENDING</div></div>
  </div>
  <div class="nt">ğŸ° Your Numbers (<span id="rC">0</span>)</div>
  <div class="nbox"><div class="ngrid" id="nG"></div></div>
  <div class="acts">
    <button class="btn b2" onclick="cpA()">ğŸ“‹ Copy</button>
    <button class="btn b2" onclick="dlA()">â¬‡ Download</button>
    <button class="btn b2" onclick="prA()">ğŸ–¨ Print</button>
  </div>
  <button class="btn b1" style="margin-top:16px" onclick="again()">ğŸ° Buy More</button>
</div>
</div>

<footer>Â© 2024 Piso Palaro &bull; GCash only &bull; Numbers: 000000â€“199999</footer>
</div>
</div>

<!-- ADMIN PAGE -->
<div id="adminPage" style="display:none">
<div id="adminLogin" class="login-wrap">
<div class="login-box">
  <h1>ğŸ” PISO PALARO</h1>
  <div class="lsub">Admin Panel</div>
  <div class="fg"><label>Username</label><input id="loginUser" placeholder="Username"></div>
  <div class="fg"><label>Password</label><input id="loginPass" type="password" placeholder="Password"></div>
  <button class="btn b1" id="loginBtn" onclick="doLogin()">ğŸ”‘ Sign In</button>
  <a href="#" onclick="goToPublicPage();return false" class="pub-link">ğŸ° Go to Public Page â†’</a>
</div>
</div>

<div class="admin" id="adminPanel">
<div class="topbar">
  <h1>ğŸ° PISO PALARO â€” Admin</h1>
  <div class="user"><span id="adminUser">admin</span><button class="logout" onclick="doLogout()">Logout</button></div>
</div>
<div class="mob-nav">
  <div class="nav-item active" onclick="goPage('dashboard')">ğŸ“Š Dashboard</div>
  <div class="nav-item" onclick="goPage('transactions')">ğŸ“‹ TX</div>
  <div class="nav-item" onclick="goPage('numbers')">ğŸ”¢ Numbers</div>
  <div class="nav-item" onclick="goPage('search')">ğŸ” Search</div>
  <div class="nav-item" onclick="goPage('tools')">ğŸ”§ Tools</div>
  <div class="nav-item" onclick="goPage('settings')">âš™ï¸ Settings</div>
</div>
<div class="admain">
<div class="sidebar">
  <div class="nav-item active" data-page="dashboard" onclick="goPage('dashboard')">ğŸ“Š Dashboard</div>
  <div class="nav-item" data-page="transactions" onclick="goPage('transactions')">ğŸ“‹ Transactions</div>
  <div class="nav-item" data-page="numbers" onclick="goPage('numbers')">ğŸ”¢ Sold Numbers</div>
  <div class="nav-sep"></div>
  <div class="nav-item" data-page="search" onclick="goPage('search')">ğŸ” Search</div>
  <div class="nav-item" data-page="tools" onclick="goPage('tools')">ğŸ”§ Tools</div>
  <div class="nav-sep"></div>
  <div class="nav-item" data-page="settings" onclick="goPage('settings')">âš™ï¸ Settings</div>
</div>
<div class="content">

<div class="page active" id="pg-dashboard">
  <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;margin-bottom:8px">
    <div><div class="page-title">Dashboard</div><div class="page-sub" style="margin-bottom:0">Real-time overview</div></div>
    <a href="#" onclick="goToPublicPage();return false" class="pub-link-btn">ğŸ° Public Page â†—</a>
  </div>
  <div class="stats">
    <div class="stat gold"><div class="sl">Total Sold</div><div class="sv" id="dsSold">â€”</div><div class="bar-track"><div class="bar-fill" id="dsBar" style="width:0"></div></div></div>
    <div class="stat green"><div class="sl">Remaining</div><div class="sv" id="dsRemain">â€”</div><div class="sc" id="dsPct" style="color:var(--ok)">â€”</div></div>
    <div class="stat blue"><div class="sl">Revenue (Approved)</div><div class="sv" id="dsRevenue">â€”</div></div>
    <div class="stat yellow"><div class="sl">Pending</div><div class="sv" id="dsPending">â€”</div></div>
    <div class="stat green"><div class="sl">Approved</div><div class="sv" id="dsApproved">â€”</div></div>
    <div class="stat red"><div class="sl">Declined</div><div class="sv" id="dsDeclined">â€”</div></div>
    <div class="stat blue"><div class="sl">Unique Buyers</div><div class="sv" id="dsBuyers">â€”</div></div>
  </div>
  <div class="tbl-wrap">
    <div class="tbl-head"><h3>ğŸ“¡ Recent Activity</h3><button class="btn-sm btn-blue" onclick="refreshDashboard()">â†» Refresh</button></div>
    <ul class="feed" id="feedList"><li class="tbl-empty">Loading...</li></ul>
  </div>
</div>

<div class="page" id="pg-transactions">
  <div class="page-title">Transactions</div>
  <div class="page-sub">Click any row to view details</div>
  <div class="tbl-wrap">
    <div class="tbl-head">
      <h3>ğŸ“‹ Log</h3>
      <div class="tbl-actions">
        <button class="btn-sm btn-green" onclick="exportData('transactions')">â¬‡ Export</button>
        <button class="btn-sm btn-blue" onclick="refreshTransactions()">â†»</button>
        <button class="btn-sm btn-red" onclick="confirmDeleteAll()">ğŸ—‘ Delete All</button>
      </div>
    </div>
    <div style="overflow-x:auto">
      <table><thead><tr><th>Timestamp</th><th>TX ID</th><th>Name</th><th>Phone</th><th>GCash</th><th>Qty</th><th>Amt</th><th>Status</th><th>Actions</th></tr></thead>
      <tbody id="txBody"><tr><td colspan="9" class="tbl-empty">Loading...</td></tr></tbody></table>
    </div>
    <div class="pagination" id="txPagination"></div>
  </div>
</div>

<div class="page" id="pg-numbers">
  <div class="page-title">Sold Numbers</div>
  <div class="page-sub">Click any row to view transaction details. Format: 000000â€“199999</div>
  <div class="tbl-wrap">
    <div class="tbl-head">
      <h3>ğŸ”¢ Registry</h3>
      <div class="tbl-actions">
        <button class="btn-sm btn-green" onclick="exportData('sold')">â¬‡ Export</button>
        <button class="btn-sm btn-blue" onclick="refreshNumbers()">â†»</button>
      </div>
    </div>
    <div style="overflow-x:auto">
      <table><thead><tr><th>Number</th><th>TX ID</th><th>Name</th><th>Phone</th><th>GCash</th><th>Timestamp</th></tr></thead>
      <tbody id="numBody"><tr><td colspan="6" class="tbl-empty">Loading...</td></tr></tbody></table>
    </div>
    <div class="pagination" id="numPagination"></div>
  </div>
</div>

<div class="page" id="pg-search">
  <div class="page-title">Search</div>
  <div class="page-sub">Click any result to view full transaction details</div>
  <div class="tool-card"><h3>ğŸ” By Number <span style="font-size:.7rem;color:var(--sub);font-weight:400">(000000â€“199999)</span></h3><div class="tool-row"><div class="fg"><label>6-Digit Number</label><input id="searchNum" maxlength="6" placeholder="042069" inputmode="numeric"></div><button class="btn-sm btn-gold" onclick="searchNumber()" style="height:42px">Search</button></div><div class="search-loading" id="sl1"><div class="sp-sm"></div> Searching...</div></div>
  <div class="tool-card"><h3>ğŸ‘¤ By Buyer</h3><div class="tool-row"><div class="fg"><label>Name / Phone / TX / GCash</label><input id="searchBuyer" placeholder="Juan"></div><button class="btn-sm btn-gold" onclick="searchBuyerFn()" style="height:42px">Search</button></div><div class="search-loading" id="sl2"><div class="sp-sm"></div> Searching...</div></div>
  <div class="tool-card"><h3>ğŸ”„ Duplicate Number Checker</h3><p style="color:var(--sub);font-size:.82rem;margin-bottom:12px;line-height:1.7">Scan all sold numbers for duplicates across the entire registry.</p><button class="btn-sm btn-orange" onclick="searchDuplicates()" id="dupeBtn">ğŸ”„ Scan for Duplicates</button><div class="search-loading" id="sl3"><div class="sp-sm"></div> Scanning all numbers...</div><div id="dupeResult" style="display:none;margin-top:14px"><div id="dupeSummary" style="padding:14px;border-radius:10px;margin-bottom:12px;line-height:1.8;font-size:.88rem"></div></div></div>
  <div class="tbl-wrap" id="searchResults" style="display:none"><div class="tbl-head"><h3 id="searchTitle"></h3></div><div style="overflow-x:auto"><table><thead id="searchThead"></thead><tbody id="searchTbody"></tbody></table></div></div>
</div>

<div class="page" id="pg-tools">
  <div class="page-title">Tools</div>
  <div class="page-sub">Manual operations (numbers must be 000000â€“199999)</div>
  <div class="tool-card"><h3>â• Add Number</h3><div class="tool-row"><div class="fg"><label>Number (1st digit 0 or 1)</label><input id="addNum" maxlength="6" placeholder="042069" inputmode="numeric"></div><div class="fg"><label>Name</label><input id="addName" placeholder="Optional"></div><div class="fg"><label>Phone</label><input id="addPhone" maxlength="11" placeholder="Optional"></div><button class="btn-sm btn-green" onclick="addNumber()" style="height:42px">Add</button></div></div>
  <div class="tool-card"><h3>â– Remove Number</h3><div class="tool-row"><div class="fg"><label>Number</label><input id="removeNum" maxlength="6" placeholder="042069" inputmode="numeric"></div><button class="btn-sm btn-red" onclick="removeNumber()" style="height:42px">Remove</button></div></div>
  <div class="tool-card"><h3>ğŸ“¥ Export</h3><div style="display:flex;gap:10px;flex-wrap:wrap"><button class="btn-sm btn-green" onclick="exportData('sold')">â¬‡ Sold CSV</button><button class="btn-sm btn-blue" onclick="exportData('transactions')">â¬‡ TX CSV</button></div></div>
</div>

<div class="page" id="pg-settings">
  <div class="page-title">Settings</div>
  <div class="page-sub">Live configuration</div>
  <div class="settings-grid">
    <div class="setting-group"><h3>ğŸ’³ GCash</h3><div class="fg"><label>Name</label><input id="setGcashName"></div><div class="fg"><label>Number</label><input id="setGcashNum"></div></div>
    <div class="setting-group"><h3>ğŸ° Lottery</h3><div class="fg"><label>Name</label><input id="setLotteryName"></div><div class="fg"><label>Draw Date</label><input id="setDrawDate" type="date"></div></div>
    <div class="setting-group"><h3>ğŸ”¢ Limits</h3><div class="fg"><label>Price (â‚±)</label><input id="setPrice" type="number" min="1"></div><div class="fg"><label>Min Qty</label><input id="setMinQty" type="number" min="1"></div><div class="fg"><label>Max Qty</label><input id="setMaxQty" type="number" min="1"></div></div>
    <div class="setting-group"><h3>ğŸ“¢ Announcement</h3><div class="fg"><label>Message</label><textarea id="setAnnouncement" placeholder="Blank = hidden"></textarea></div><div class="fg"><label>Maintenance</label><select id="setMaintenance"><option value="false">Off</option><option value="true">On</option></select></div></div>
  </div>
  <div class="setting-group"><h3>ğŸ” Password</h3><div class="settings-grid"><div class="fg"><label>New</label><input id="setNewPass" type="password" placeholder="Min 6"><small style="color:var(--sub)">Blank = keep current</small></div><div class="fg"><label>Confirm</label><input id="setNewPass2" type="password" placeholder="Repeat"></div></div></div>
  <button class="btn b1" onclick="saveSettings()" style="max-width:300px">ğŸ’¾ Save Settings</button>
</div>

</div></div></div>
</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PISO PALARO â€” Frontend v4.1 (Fixed)
   - Removed time column (merged into timestamp)
   - TX ID with hyphens
   - Delete safety: must decline first if numbers exist
   - Auth failure handling
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwq7grZ-IzjEUPj_Nz9MBdwzo6Lb_VrKCvAEFMKh8mtWCYQ2SH6meyiAuKNfwVNlav5MA/exec';
const ADMIN_SECRET = 'admin';
const TOTAL_POOL = 200000;
const MAX_RETRY = 3;
const RETRY_MS = [3000, 5000, 8000];
const FETCH_TIMEOUT = 120000;
const MAX_NAME_LEN = 40;

let GCASH_NUMBER = '09171234567';
let GCASH_NAME = 'Juan Dela Cruz';
let PRICE_PER = 1, MIN_QTY = 100, MAX_QTY = 10000, LOTTERY_NAME = 'PISO PALARO';
let myNums = [], serverOnline = false, TOKEN = '';
let currentPage = { tx: 1, num: 1 }, IS_ADMIN_MODE = false;
let _detailTx = null;
let _art = null, _kat = null, activeP = 'dashboard';
let _purchaseInProgress = false;

function $(id) { return document.getElementById(id); }
function show(id) { $(id).classList.remove('hide'); }
function hide(id) { $(id).classList.add('hide'); }
function pad6(n) { return String(n).padStart(6, '0').substring(0, 6); }

function esc(s) {
  var d = document.createElement('div');
  d.appendChild(document.createTextNode(String(s)));
  return d.innerHTML;
}

function getDigitsOnly(s) { return String(s).replace(/\D/g, ''); }
function isValidPhone(s) { var d = getDigitsOnly(s); return d.length === 11 && d.indexOf('09') === 0; }
function isValidNumber(num) { return /^\d{6}$/.test(num) && parseInt(num[0], 10) <= 1; }

function sanitizeInput(str, maxLen) {
  str = String(str || '').trim()
    .replace(/<[^>]*>/g, '')
    .replace(/[<>"'`;{}()\\]/g, '')
    .replace(/[\x00-\x1F\x7F]/g, '');
  return maxLen ? str.substring(0, maxLen) : str;
}

function toast(m, t) {
  var e = $('toast');
  e.textContent = m;
  e.className = 'toast ' + t + ' on';
  clearTimeout(e._t);
  e._t = setTimeout(function() { e.classList.remove('on'); }, 4000);
}

function showOv(t, s) { $('ovT').textContent = t || ''; $('ovS').textContent = s || ''; $('ov').classList.add('on'); }
function hideOv() { $('ov').classList.remove('on'); }
function closeConfirm() { $('confirmModal').classList.remove('on'); }
function closeDetail() { $('detailModal').classList.remove('on'); _detailTx = null; }
function goToPublicPage() { window.open(location.href.split('?')[0], '_blank'); }

function cpField(id) {
  navigator.clipboard.writeText($(id).textContent)
    .then(function() { toast('ğŸ“‹ Copied!', 'suc'); })
    .catch(function() { toast('Copy failed', 'err'); });
}

function detectMode() {
  if (new URLSearchParams(location.search).get('access') === ADMIN_SECRET) {
    IS_ADMIN_MODE = true;
    $('publicPage').style.display = 'none';
    $('adminPage').style.display = 'block';
    document.title = 'Admin â€” ' + LOTTERY_NAME;
  }
}

// â”€â”€ Fetch with abort support â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function safeFetch(url, ms) {
  return new Promise(function(resolve, reject) {
    var c = new AbortController();
    var t = setTimeout(function() { c.abort(); }, ms || FETCH_TIMEOUT);
    fetch(url, { redirect: 'follow', signal: c.signal })
      .then(function(r) {
        clearTimeout(t);
        if (!r.ok) throw new Error('HTTP_' + r.status);
        return r.text();
      })
      .then(function(txt) {
        txt = txt.trim();
        if (txt.indexOf('<!DOCTYPE') === 0 || txt.indexOf('<html') === 0) throw new Error('HTML_RESPONSE');
        try { resolve(JSON.parse(txt)); }
        catch (e) {
          var m = txt.match(/\{[\s\S]*\}/);
          if (m) resolve(JSON.parse(m[0]));
          else throw new Error('PARSE_ERROR');
        }
      })
      .catch(function(err) {
        clearTimeout(t);
        if (err.name === 'AbortError') reject(new Error('TIMEOUT'));
        else reject(err);
      });
  });
}

// â”€â”€ Date â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function parseDrawDate(s) {
  if (!s) return null;
  var p = String(s).trim().split('-');
  if (p.length === 3) { var d = new Date(+p[0], +p[1]-1, +p[2]); return isNaN(d) ? null : d; }
  var f = new Date(s); return isNaN(f) ? null : f;
}
function formatDrawDate(s) {
  var d = parseDrawDate(s); if (!d) return null;
  return d.toLocaleDateString('en-US', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
}
function setTodayDate() {
  $('dateToday').textContent = new Date().toLocaleDateString('en-PH', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
}

// â”€â”€ Settings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function applyPublicSettings(s) {
  if (s.lottery_name) {
    LOTTERY_NAME = String(s.lottery_name).substring(0, 60);
    document.title = LOTTERY_NAME;
    var p = LOTTERY_NAME.split(' '), logo = $('logoText');
    logo.textContent = '';
    logo.appendChild(document.createTextNode('ğŸ° ' + (p.length >= 2 ? p.slice(0, -1).join(' ') : LOTTERY_NAME)));
    if (p.length >= 2) { var sp = document.createElement('span'); sp.textContent = p[p.length - 1]; logo.appendChild(sp); }
  }
  if (s.gcash_name) { GCASH_NAME = String(s.gcash_name).substring(0, 60); $('dN').textContent = GCASH_NAME; }
  if (s.gcash_number) { GCASH_NUMBER = String(s.gcash_number).substring(0, 20); $('dP').textContent = GCASH_NUMBER; }
  if (s.price_per_number > 0) {
    PRICE_PER = parseFloat(s.price_per_number) || 1;
    $('priceTag').textContent = 'â‚±' + PRICE_PER.toFixed(2) + ' PER ENTRY';
    $('tagLine').textContent = 'Get your lucky numbers â€” only â‚±' + PRICE_PER.toFixed(2) + ' each!';
  }
  if (s.min_quantity > 0) { MIN_QTY = parseInt(s.min_quantity) || 100; $('fQ').min = MIN_QTY; $('minQtySpan').textContent = MIN_QTY; }
  if (s.max_quantity > 0) { MAX_QTY = parseInt(s.max_quantity) || 10000; $('fQ').max = MAX_QTY; }
  var fd = formatDrawDate(s.draw_date);
  $('drawBanner').style.display = fd ? 'block' : 'none';
  if (fd) $('drawDateText').textContent = fd;
  if (s.announcement && String(s.announcement).trim()) {
    $('announceText').textContent = String(s.announcement).substring(0, 500);
    $('announceBanner').style.display = 'block';
  } else $('announceBanner').style.display = 'none';
  if (s.maintenance_mode) $('maintOverlay').classList.add('on');
  else $('maintOverlay').classList.remove('on');
  calc();
}

function updateProgress(sold, rem) {
  var pct = Math.max(0, Math.min(100, (rem / TOTAL_POOL) * 100));
  var f = $('progressFill'), t = $('availTxt');
  f.style.width = pct + '%';
  f.classList.remove('mid', 'low'); t.classList.remove('high', 'mid', 'low');
  if (pct > 60) { t.textContent = 'Plenty available (' + rem.toLocaleString() + ')'; t.classList.add('high'); }
  else if (pct > 30) { t.textContent = 'Selling fast (' + rem.toLocaleString() + ')'; t.classList.add('mid'); f.classList.add('mid'); }
  else if (pct > 10) { t.textContent = 'Running low (' + rem.toLocaleString() + ')'; t.classList.add('low'); f.classList.add('low'); }
  else { t.textContent = pct > 0 ? 'Almost sold out!' : 'Sold out'; t.classList.add('low'); f.classList.add('low'); }
}

function checkConnection() {
  var bar = $('connBar'), txt = $('connTxt'), ep = $('errPanel');
  bar.className = 'conn checking'; txt.textContent = 'Connecting...'; ep.classList.add('hide');
  Promise.all([
    safeFetch(SCRIPT_URL + '?action=health', 30000),
    safeFetch(SCRIPT_URL + '?action=publicSettings', 30000),
    safeFetch(SCRIPT_URL + '?action=stats', 30000)
  ]).then(function(results) {
    var h = results[0], s = results[1], st = results[2];
    if (h && h.success) { serverOnline = true; bar.className = 'conn online'; txt.textContent = 'âœ“ Connected'; }
    if (s && s.success) applyPublicSettings(s);
    if (st && st.success) updateProgress(st.sold, st.remaining);
  }).catch(function(err) {
    bar.className = 'conn offline';
    txt.textContent = 'âœ— ' + (err.message === 'TIMEOUT' ? 'Timed out' : err.message);
    $('errDetail').innerHTML = '<button class="retry-btn" onclick="checkConnection()">ğŸ”„ Retry</button>';
    ep.classList.remove('hide');
  });
}

// â”€â”€ Phone â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updatePhoneStatus() {
  var r = $('fP').value, d = getDigitsOnly(r);
  var errEl = $('phoneErr'), okEl = $('phoneOk'), inp = $('fP');
  if (!r) { errEl.style.display = 'none'; okEl.style.display = 'none'; inp.style.borderColor = 'rgba(255,255,255,.1)'; return; }
  if (d.length === 11 && d.indexOf('09') === 0) {
    errEl.style.display = 'none'; okEl.style.display = 'block'; inp.style.borderColor = 'var(--ok)';
  } else {
    okEl.style.display = 'none'; errEl.style.display = 'block';
    errEl.textContent = d.length < 11 ? 'Need 11 digits (' + d.length + '/11)' : (d.indexOf('09') !== 0 ? 'Must start with 09' : 'Invalid');
    inp.style.borderColor = 'var(--err)';
  }
}

// â”€â”€ Quantity â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addQty(n, el) {
  var cur = parseInt($('fQ').value) || 0, next = cur + n;
  if (next > MAX_QTY) { if (cur >= MAX_QTY) return toast('Already at max.', 'warn'); next = MAX_QTY; }
  $('fQ').value = next; calc();
  if (el) { el.classList.add('qp-added'); setTimeout(function() { el.classList.remove('qp-added'); }, 350); }
}
function setMaxQtyFn() { if (parseInt($('fQ').value) === MAX_QTY) return toast('Already at max.', 'warn'); $('fQ').value = MAX_QTY; calc(); }
function resetQty() { $('fQ').value = ''; calc(); }
function calc() {
  var v = Math.min(MAX_QTY, Math.max(0, parseInt($('fQ').value) || 0));
  $('dT').textContent = 'â‚± ' + (v * PRICE_PER).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

// â”€â”€ Steps â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function stpSet(n) {
  $('i1').className = n === 1 ? 'stp on' : 'stp ok';
  $('i2').className = n === 2 ? 'stp on' : n > 2 ? 'stp ok' : 'stp';
  $('i3').className = n === 3 ? 'stp on' : 'stp';
  $('l1').className = n >= 2 ? 'sln on' : 'sln';
  $('l2').className = n >= 3 ? 'sln on' : 'sln';
}
function go2() {
  var nm = sanitizeInput($('fN').value, MAX_NAME_LEN), ph = $('fP').value.trim(), qt = parseInt($('fQ').value);
  if (!nm || nm.length < 2) return toast('Enter full name.', 'err');
  if (!isValidPhone(ph)) return toast('Phone: 11 digits starting with 09.', 'err');
  if (!qt || qt < MIN_QTY) { $('fQ').value = MIN_QTY; calc(); return toast('Min ' + MIN_QTY + '.', 'err'); }
  if (qt > MAX_QTY) { $('fQ').value = MAX_QTY; calc(); return toast('Max ' + MAX_QTY.toLocaleString() + '.', 'err'); }
  hide('p1'); show('p2');
  $('dA').textContent = ' â‚± ' + (qt * PRICE_PER).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  stpSet(2);
}
function go1() { hide('p2'); show('p1'); stpSet(1); }

// â”€â”€ Purchase â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function submitPurchase() {
  if (_purchaseInProgress) return toast('Already processing...', 'warn');
  var ref = $('fR').value.trim();
  if (!ref) return toast('Enter GCash ref.', 'err');
  if (!/^\d{1,13}$/.test(ref)) return toast('Digits only (max 13).', 'err');
  if (!serverOnline) { toast('Offline.', 'err'); checkConnection(); return; }
  var nm = sanitizeInput($('fN').value, MAX_NAME_LEN);
  var ph = getDigitsOnly($('fP').value).substring(0, 11);
  var qt = parseInt($('fQ').value);
  if (!nm || nm.length < 2) return toast('Invalid name.', 'err');
  if (!isValidPhone(ph)) return toast('Invalid phone.', 'err');
  if (!qt || qt < MIN_QTY || qt > MAX_QTY) return toast('Invalid quantity.', 'err');
  $('buyBtn').disabled = true; _purchaseInProgress = true;
  attemptPurchase(nm, ph, qt, ref, 0);
}

function attemptPurchase(nm, ph, qt, ref, tryN) {
  if (tryN === 0) showOv('Generating ' + qt.toLocaleString() + ' numbers...', 'Please wait â€” this may take a moment');
  else {
    showOv('Retry ' + tryN + '/' + MAX_RETRY, 'Retrying in a moment...');
    setTimeout(function() { doAttemptPurchase(nm, ph, qt, ref, tryN); }, RETRY_MS[tryN - 1]);
    return;
  }
  doAttemptPurchase(nm, ph, qt, ref, tryN);
}

function doAttemptPurchase(nm, ph, qt, ref, tryN) {
  var params = new URLSearchParams({ action: 'purchase', quantity: qt, name: nm, phone: ph, gcashRef: ref });
  safeFetch(SCRIPT_URL + '?' + params, FETCH_TIMEOUT)
    .then(function(d) {
      if (d.success) {
        hideOv(); $('buyBtn').disabled = false; _purchaseInProgress = false;
        myNums = d.numbers.map(function(n) { return pad6(n); });
        showResult(d, nm, ph, qt, ref);
        toast('â³ ' + d.quantity.toLocaleString() + ' numbers reserved!', 'warn');
      } else if (d.retryable && tryN < MAX_RETRY) {
        attemptPurchase(nm, ph, qt, ref, tryN + 1);
      } else { hideOv(); $('buyBtn').disabled = false; _purchaseInProgress = false; toast(d.error || 'Failed.', 'err'); }
    })
    .catch(function(err) {
      if (tryN < MAX_RETRY) attemptPurchase(nm, ph, qt, ref, tryN + 1);
      else { hideOv(); $('buyBtn').disabled = false; _purchaseInProgress = false; toast(err.message, 'err'); }
    });
}

// â”€â”€ Receipt â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function censorName(n) { return n.trim().split(/\s+/).map(function(w, i) { return i === 0 ? w : w.charAt(0) + '***'; }).join(' '); }
function censorPhone(p) { return p.substring(0, 5) + '******'; }

function showResult(d, nm, ph, qt, ref) {
  hide('secB'); show('secR'); stpSet(3);
  $('rI').textContent = d.transactionId; $('rD').textContent = d.timestamp;
  $('rN').textContent = censorName(nm); $('rP').textContent = censorPhone(ph);
  $('rQ').textContent = d.quantity.toLocaleString();
  $('rA').textContent = 'â‚± ' + Number(d.amount).toLocaleString(undefined, { minimumFractionDigits: 2 });
  $('rR').textContent = ref; $('rS').textContent = 'â³ PENDING';
  $('rC').textContent = myNums.length.toLocaleString();
  var frag = document.createDocumentFragment();
  myNums.forEach(function(n) {
    var div = document.createElement('div');
    div.className = 'ni';
    div.textContent = n;
    frag.appendChild(div);
  });
  var nG = $('nG');
  nG.innerHTML = '';
  nG.appendChild(frag);
  scrollTo({ top: 0, behavior: 'smooth' });
}

function cpA() { navigator.clipboard.writeText(myNums.join('\n')).then(function() { toast('Copied!', 'suc'); }).catch(function() { toast('Failed', 'err'); }); }
function dlA() {
  var L = [LOTTERY_NAME, 'TX: ' + $('rI').textContent, 'Date: ' + $('rD').textContent, 'GCash Ref: ' + $('rR').textContent, 'Status: PENDING', 'Qty: ' + myNums.length, 'Amount: ' + $('rA').textContent, '', 'NUMBERS:', ''];
  myNums.forEach(function(n) { L.push(n); });
  var a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([L.join('\n')], { type: 'text/plain' }));
  a.download = 'PisoPalaro-' + $('rI').textContent + '.txt'; a.click(); toast('Downloaded!', 'suc');
}
function prA() {
  var w = window.open('');
  w.document.write('<!DOCTYPE html><html><head><title>' + esc(LOTTERY_NAME) + '</title><style>body{font-family:monospace;padding:20px;font-size:12px}.g{display:grid;grid-template-columns:repeat(6,1fr);gap:3px}.n{border:1px solid #ddd;padding:5px;text-align:center;font-weight:bold;letter-spacing:2px}.p{background:#fff3e0;border:2px solid #ff9800;padding:10px;margin:10px 0;text-align:center;font-weight:bold;border-radius:6px}</style></head><body><h1 style="text-align:center">' + esc(LOTTERY_NAME) + '</h1><div class="p">â³ PENDING APPROVAL</div><p>TX: ' + esc($('rI').textContent) + '<br>GCash Ref: ' + esc($('rR').textContent) + '<br>Qty: ' + myNums.length + ' | ' + esc($('rA').textContent) + '</p><div class="g">' + myNums.map(function(n) { return '<div class="n">' + n + '</div>'; }).join('') + '</div></body></html>');
  w.document.close(); setTimeout(function() { w.print(); }, 300);
}
function cpGC() { navigator.clipboard.writeText(GCASH_NUMBER.replace(/\D/g, '')).then(function() { toast('Copied!', 'suc'); }).catch(function() {}); }

function again() {
  hide('secR'); show('secB');
  ['fN', 'fP', 'fQ', 'fR'].forEach(function(id) { $(id).value = ''; });
  $('dT').textContent = 'â‚± 0.00'; $('phoneErr').style.display = 'none'; $('phoneOk').style.display = 'none';
  $('fP').style.borderColor = 'rgba(255,255,255,.1)';
  hide('p2'); show('p1'); stpSet(1); myNums = [];
  scrollTo({ top: 0, behavior: 'smooth' }); checkConnection();
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//   ADMIN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function adminApi(a, p) {
  p = p || {}; p.action = a; p.token = TOKEN;
  return safeFetch(SCRIPT_URL + '?' + new URLSearchParams(p), 120000).then(function(d) {
    // Handle auth failures globally
    if (d && d.authFailed) {
      toast('Session expired. Please login again.', 'err');
      doLogout();
      throw new Error('AUTH_FAILED');
    }
    return d;
  });
}

function doLogin() {
  var u = $('loginUser').value.trim(), p = $('loginPass').value.trim();
  if (!u || !p) return toast('Enter credentials.', 'err');
  $('loginBtn').disabled = true; showOv('Signing in...', '');
  adminApi('adminLogin', { username: u, password: p }).then(function(d) {
    hideOv(); $('loginBtn').disabled = false;
    if (d.success) {
      TOKEN = d.token; $('adminUser').textContent = d.username || u;
      $('adminLogin').style.display = 'none'; $('adminPanel').style.display = 'block';
      toast('Welcome!', 'suc');
      showOv('Loading dashboard...', '');
      loadDashboard().then(function() { hideOv(); }).catch(function() { hideOv(); });
      startAutoRefresh(); startKeepAlive();
    } else toast(d.error || 'Login failed', 'err');
  }).catch(function(e) {
    if (e.message !== 'AUTH_FAILED') toast(e.message, 'err');
    hideOv(); $('loginBtn').disabled = false;
  });
}

function doLogout() {
  TOKEN = ''; $('adminPanel').style.display = 'none'; $('adminLogin').style.display = 'flex';
  $('loginUser').value = ''; $('loginPass').value = '';
  if (_art) { clearInterval(_art); _art = null; }
  if (_kat) { clearInterval(_kat); _kat = null; }
  toast('Logged out.', 'warn');
}

function startKeepAlive() {
  if (_kat) clearInterval(_kat);
  _kat = setInterval(function() { if (TOKEN) fetch(SCRIPT_URL + '?action=health', { redirect: 'follow' }).catch(function() {}); }, 55000);
}

function goPage(n) {
  activeP = n;
  document.querySelectorAll('.page').forEach(function(p) { p.classList.remove('active'); });
  $('pg-' + n).classList.add('active');
  document.querySelectorAll('.sidebar .nav-item').forEach(function(x) { x.classList.remove('active'); });
  document.querySelectorAll('[data-page="' + n + '"]').forEach(function(x) { x.classList.add('active'); });
  document.querySelectorAll('.mob-nav .nav-item').forEach(function(x) {
    x.classList.remove('active');
    if (x.textContent.toLowerCase().indexOf(n.substring(0, 4)) !== -1) x.classList.add('active');
  });
  if (n === 'dashboard') loadDashboard();
  else if (n === 'transactions') loadTransactions();
  else if (n === 'numbers') loadNumbers();
  else if (n === 'settings') loadSettingsFn();
}

function statusClass(s) { return s === 'APPROVED' ? 'ok' : s === 'PENDING' ? 'pend' : 'dec'; }

// â”€â”€ DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadDashboard() {
  $('feedList').innerHTML = '<li class="tbl-empty">Loading...</li>';
  return adminApi('adminDashboard').then(function(d) {
    if (d && d.success) renderDashboard(d);
    else $('feedList').innerHTML = '<li class="tbl-empty">Failed. <button class="retry-btn" onclick="loadDashboard()">Retry</button></li>';
  }).catch(function(e) {
    if (e.message !== 'AUTH_FAILED') $('feedList').innerHTML = '<li class="tbl-empty">Error: ' + esc(e.message) + ' <button class="retry-btn" onclick="loadDashboard()">Retry</button></li>';
  });
}

function refreshDashboard() { toast('Refreshing...', 'warn'); loadDashboard(); }

function renderDashboard(d) {
  $('dsSold').textContent = (Number(d.sold) || 0).toLocaleString();
  $('dsRemain').textContent = (Number(d.remaining) || 0).toLocaleString();
  $('dsPct').textContent = (d.percentSold || 0) + '% sold';
  $('dsRevenue').textContent = 'â‚±' + (Number(d.totalRevenue) || 0).toLocaleString();
  $('dsPending').textContent = (Number(d.pendingTransactions) || 0).toLocaleString();
  $('dsApproved').textContent = (Number(d.approvedTransactions) || 0).toLocaleString();
  $('dsDeclined').textContent = (Number(d.declinedTransactions) || 0).toLocaleString();
  $('dsBuyers').textContent = (Number(d.uniqueBuyers) || 0).toLocaleString();

  var sold = Number(d.sold) || 0, tp = Number(d.totalPool) || TOTAL_POOL;
  var pct = tp > 0 ? (sold / tp) * 100 : 0;
  var bar = $('dsBar');
  bar.style.width = pct + '%';
  bar.classList.remove('mid', 'low');
  if (pct > 70) bar.classList.add('low');
  else if (pct > 40) bar.classList.add('mid');

  var acts = d.recentActivity || [];
  var list = $('feedList');
  if (!acts.length) { list.innerHTML = '<li class="tbl-empty">No activity yet.</li>'; return; }

  var h = '';
  for (var i = 0; i < acts.length; i++) {
    var a = acts[i], dc = statusClass(a.status);
    h += '<li style="cursor:pointer;align-items:flex-start" onclick="openTxDetail(\'' + esc(a.transactionId) + '\')">' +
      '<div class="dot ' + dc + '" style="margin-top:4px;flex-shrink:0"></div>' +
      '<div style="flex:1;min-width:0">' +
        '<div style="display:flex;justify-content:space-between;align-items:flex-start;gap:6px">' +
          '<strong style="word-break:break-word">' + esc(a.name) + '</strong>' +
          '<span class="badge ' + dc + '" style="flex-shrink:0">' + esc(a.status) + '</span>' +
        '</div>' +
        '<div style="font-size:.8rem;color:var(--sub);margin-top:2px">' + (Number(a.quantity)||0).toLocaleString() + ' entries Â· â‚±' + (Number(a.amount)||0).toLocaleString() + '</div>' +
        '<span class="time" style="display:block;margin-top:2px">' + esc(a.timestamp) + '<br>' + esc(a.transactionId) + '</span>' +
      '</div></li>';
  }
  list.innerHTML = h;
}

// â”€â”€ TRANSACTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildTxActions(status, txId) {
  var safe = esc(txId);
  var a = '<div class="tx-actions">';
  if (status === 'PENDING') a += '<button class="btn-sm btn-green" onclick="event.stopPropagation();confirmApprove(\'' + safe + '\')">âœ“</button><button class="btn-sm btn-red" onclick="event.stopPropagation();confirmDecline(\'' + safe + '\')">âœ—</button>';
  a += '<button class="btn-sm btn-orange" onclick="event.stopPropagation();confirmDelete(\'' + safe + '\')">ğŸ—‘</button></div>';
  return a;
}

function renderTransactions(d) {
  var b = $('txBody');
  if (!d.transactions || !d.transactions.length) {
    b.innerHTML = '<tr><td colspan="9" class="tbl-empty">No transactions.</td></tr>';
    $('txPagination').innerHTML = ''; return;
  }
  var h = '';
  d.transactions.forEach(function(t) {
    var sc = statusClass(t.status), txE = esc(t.transactionId);
    h += '<tr data-tx="' + txE + '" class="clickable-row" onclick="openTxDetail(\'' + txE + '\')">' +
      '<td>' + esc(t.timestamp) + '</td>' +
      '<td class="mono" style="font-size:.73rem">' + txE + '</td>' +
      '<td>' + esc(t.name) + '</td><td>' + esc(t.phone) + '</td><td>' + esc(t.gcashRef) + '</td>' +
      '<td>' + Number(t.quantity).toLocaleString() + '</td><td>â‚±' + Number(t.amount).toLocaleString() + '</td>' +
      '<td><span class="badge ' + sc + '">' + esc(t.status) + '</span></td>' +
      '<td>' + buildTxActions(t.status, t.transactionId) + '</td></tr>';
  });
  b.innerHTML = h;
  renderPg('txPagination', d.page, d.totalPages, 'loadTransactions');
}

function refreshTransactions() { loadTransactions(); }

function loadTransactions(pg) {
  if (pg) currentPage.tx = pg;
  $('txBody').innerHTML = '<tr><td colspan="9" class="tbl-empty">Loading...</td></tr>';
  adminApi('adminTransactions', { page: currentPage.tx, perPage: 30 }).then(function(d) {
    if (d && d.success) renderTransactions(d);
    else $('txBody').innerHTML = '<tr><td colspan="9" class="tbl-empty">Error loading.</td></tr>';
  }).catch(function(e) {
    if (e.message !== 'AUTH_FAILED') $('txBody').innerHTML = '<tr><td colspan="9" class="tbl-empty">Error: ' + esc(e.message) + '</td></tr>';
  });
}

// â”€â”€ NUMBERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function refreshNumbers() { loadNumbers(); }

function loadNumbers(pg) {
  if (pg) currentPage.num = pg;
  $('numBody').innerHTML = '<tr><td colspan="6" class="tbl-empty">Loading...</td></tr>';
  adminApi('adminSoldNumbers', { page: currentPage.num, perPage: 100 }).then(function(d) {
    if (d && d.success) {
      var b = $('numBody');
      if (!d.numbers.length) { b.innerHTML = '<tr><td colspan="6" class="tbl-empty">None.</td></tr>'; $('numPagination').innerHTML = ''; return; }
      var h = '';
      d.numbers.forEach(function(n) {
        h += '<tr class="clickable-row" onclick="openTxDetail(\'' + esc(n.transactionId) + '\')">' +
          '<td class="mono">' + esc(n.number) + '</td><td style="font-size:.73rem">' + esc(n.transactionId) + '</td>' +
          '<td>' + esc(n.name) + '</td><td>' + esc(n.phone) + '</td><td>' + esc(n.gcashRef) + '</td>' +
          '<td>' + esc(n.timestamp) + '</td></tr>';
      });
      b.innerHTML = h;
      renderPg('numPagination', d.page, d.totalPages, 'loadNumbers');
    }
  }).catch(function(e) {
    if (e.message !== 'AUTH_FAILED') $('numBody').innerHTML = '<tr><td colspan="6" class="tbl-empty">Error</td></tr>';
  });
}

// â”€â”€ Pagination â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderPg(cid, cur, tot, fn) {
  var c = $(cid); if (tot <= 1) { c.innerHTML = ''; return; }
  var h = '<button class="pg-btn" onclick="' + fn + '(' + (cur - 1) + ')" ' + (cur <= 1 ? 'disabled' : '') + '>â†</button>';
  var s = Math.max(1, cur - 2), e = Math.min(tot, cur + 2);
  if (s > 1) h += '<button class="pg-btn" onclick="' + fn + '(1)">1</button>';
  if (s > 2) h += '<span class="pg-info">â€¦</span>';
  for (var i = s; i <= e; i++) h += '<button class="pg-btn' + (i === cur ? ' active' : '') + '" onclick="' + fn + '(' + i + ')">' + i + '</button>';
  if (e < tot - 1) h += '<span class="pg-info">â€¦</span>';
  if (e < tot) h += '<button class="pg-btn" onclick="' + fn + '(' + tot + ')">' + tot + '</button>';
  h += '<button class="pg-btn" onclick="' + fn + '(' + (cur + 1) + ')" ' + (cur >= tot ? 'disabled' : '') + '>â†’</button> <span class="pg-info">' + cur + '/' + tot + '</span>';
  c.innerHTML = h;
}

// â”€â”€ TRANSACTION DETAIL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openTxDetail(txId) {
  showOv('Loading...', '');
  adminApi('adminGetTransaction', { transactionId: txId }).then(function(d) {
    hideOv();
    if (!d.success) { toast(d.error || 'Not found', 'err'); return; }
    renderTxDetail(d);
    $('detailModal').classList.add('on');
  }).catch(function(e) {
    hideOv();
    if (e.message !== 'AUTH_FAILED') toast(e.message, 'err');
  });
}

function renderTxDetail(d) {
  var tx = d.transaction; _detailTx = tx;
  $('detailTitle').textContent = 'ğŸ“‹ Transaction Detail';
  $('detailSub').textContent = tx.transactionId;

  var fields = [
    ['Transaction ID', tx.transactionId, 'font-family:JetBrains Mono,monospace;color:var(--gold)'],
    ['Timestamp', tx.timestamp],
    ['Name', tx.name], ['Phone', tx.phone],
    ['GCash Ref', tx.gcashRef], ['Quantity', Number(tx.quantity).toLocaleString()],
    ['Amount', 'â‚±' + Number(tx.amount).toLocaleString(), 'color:var(--gold);font-weight:800'],
    ['Status', '<span class="badge ' + statusClass(tx.status) + '">' + esc(tx.status) + '</span>']
  ];

  // Show registry status
  if (tx.numbersStillInRegistry !== undefined) {
    var regText = tx.numbersStillInRegistry
      ? '<span style="color:var(--ok)">âœ“ ' + tx.soldCount + ' in registry</span>'
      : '<span style="color:var(--sub)">â€” Freed / None</span>';
    fields.push(['Numbers in Registry', regText]);
  }

  $('detailGrid').innerHTML = fields.map(function(f) {
    return '<div class="ri"><div class="rl">' + esc(f[0]) + '</div><div class="rv"' + (f[2] ? ' style="' + f[2] + '"' : '') + '>' +
    (f[0] === 'Status' || f[0] === 'Numbers in Registry' ? f[1] : esc(String(f[1]))) + '</div></div>';
  }).join('');

  var allNums = [], nh = '';
  if (tx.soldNumbers && tx.soldNumbers.length > 0) {
    allNums = tx.soldNumbers.map(function(n) { return pad6(n); });
    nh = '<h3>ğŸ° Numbers (' + tx.soldCount.toLocaleString() + ')</h3><div class="nbox" style="max-height:300px"><div class="ngrid">';
    var display = allNums.slice(0, 500);
    nh += display.map(function(n) { return '<div class="ni">' + esc(n) + '</div>'; }).join('');
    nh += '</div></div>';
    if (allNums.length > 500) nh += '<div style="text-align:center;padding:10px;color:var(--sub)">+' + (allNums.length - 500).toLocaleString() + ' more</div>';
  } else if (tx.numbers && String(tx.numbers).trim()) {
    var nums = tx.numbers.split(',').map(function(n) { return n.trim(); }).filter(function(n) { return n; });
    allNums = nums.map(function(n) { return pad6(n); });
    nh = '<h3>ğŸ° Numbers (' + nums.length.toLocaleString() + ')</h3>';
    if (tx.status === 'DECLINED') nh += '<div style="font-size:.78rem;color:var(--err);margin-bottom:8px">âš ï¸ Numbers freed from registry</div>';
    var display2 = allNums.slice(0, 500);
    nh += '<div class="nbox" style="max-height:300px"><div class="ngrid">' +
      display2.map(function(n) { return '<div class="ni" style="opacity:' + (tx.status === 'DECLINED' ? '.4' : '1') + '">' + esc(n) + '</div>'; }).join('') + '</div></div>';
    if (nums.length > 500) nh += '<div style="text-align:center;padding:10px;color:var(--sub)">+' + (nums.length - 500).toLocaleString() + ' more</div>';
  } else { nh = '<h3>ğŸ° Numbers</h3><div style="color:var(--sub);padding:10px">No data.</div>'; }

  _detailTx._allNums = allNums;
  $('detailNums').innerHTML = nh;

  var txE = esc(tx.transactionId);
  var ah = '';
  if (allNums.length > 0) ah += '<button class="btn-sm btn-blue" onclick="copyDetailNums()">ğŸ“‹ Copy</button><button class="btn-sm btn-green" onclick="downloadDetailTx()">â¬‡ Download</button>';
  if (tx.status === 'PENDING') ah += '<button class="btn-sm btn-green" onclick="closeDetail();confirmApprove(\'' + txE + '\')">âœ… Approve</button><button class="btn-sm btn-red" onclick="closeDetail();confirmDecline(\'' + txE + '\')">âŒ Decline</button>';
  // Only show delete button if numbers are NOT in registry
  if (!tx.numbersStillInRegistry) {
    ah += '<button class="btn-sm btn-orange" onclick="closeDetail();confirmDelete(\'' + txE + '\')">ğŸ—‘ Delete</button>';
  }
  ah += '<button class="btn-sm btn-blue" onclick="closeDetail()">Close</button>';
  $('detailActions').innerHTML = ah;
}

function copyDetailNums() {
  if (!_detailTx || !_detailTx._allNums || !_detailTx._allNums.length) return toast('No numbers', 'err');
  navigator.clipboard.writeText(_detailTx._allNums.join('\n'))
    .then(function() { toast('Copied ' + _detailTx._allNums.length.toLocaleString() + ' numbers!', 'suc'); })
    .catch(function() { toast('Failed', 'err'); });
}

function downloadDetailTx() {
  if (!_detailTx) return;
  var tx = _detailTx, nums = tx._allNums || [];
  var L = [LOTTERY_NAME, '', 'TX: ' + tx.transactionId, 'Timestamp: ' + tx.timestamp, 'Name: ' + tx.name, 'Phone: ' + tx.phone, 'GCash: ' + tx.gcashRef, 'Status: ' + tx.status, 'Qty: ' + tx.quantity, 'Amount: â‚±' + Number(tx.amount).toLocaleString(), '', 'NUMBERS:', ''];
  nums.forEach(function(n) { L.push(n); });
  var a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([L.join('\n')], { type: 'text/plain' }));
  a.download = 'PisoPalaro-' + tx.transactionId + '.txt'; a.click(); toast('Downloaded!', 'suc');
}

// â”€â”€ APPROVE / DECLINE / DELETE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function confirmApprove(tx) {
  $('confirmTitle').textContent = 'âœ… Approve?';
  $('confirmMsg').innerHTML = 'Approve <code>' + esc(tx) + '</code>?';
  $('confirmYes').textContent = 'Approve'; $('confirmYes').className = 'btn-sm btn-green';
  $('confirmYes').onclick = function() { doApprove(tx); }; $('confirmModal').classList.add('on');
}
function doApprove(tx) {
  closeConfirm(); showOv('Approving...', '');
  adminApi('adminApproveTransaction', { transactionId: tx }).then(function(d) {
    hideOv();
    if (d.success) { toast('âœ… Approved!', 'suc'); refreshAfterAction(); }
    else toast(d.error || 'Failed', 'err');
  }).catch(function(e) { hideOv(); if (e.message !== 'AUTH_FAILED') toast(e.message, 'err'); });
}

function confirmDecline(tx) {
  $('confirmTitle').textContent = 'âŒ Decline?';
  $('confirmMsg').innerHTML = 'Decline <code>' + esc(tx) + '</code>?<br>Numbers will be freed from the registry.';
  $('confirmYes').textContent = 'Decline'; $('confirmYes').className = 'btn-sm btn-red';
  $('confirmYes').onclick = function() { doDecline(tx); }; $('confirmModal').classList.add('on');
}
function doDecline(tx) {
  closeConfirm(); showOv('Declining...', '');
  adminApi('adminDeclineTransaction', { transactionId: tx }).then(function(d) {
    hideOv();
    if (d.success) { toast('âŒ Declined. ' + (d.freedNumbers || 0) + ' numbers freed.', 'suc'); refreshAfterAction(); }
    else toast(d.error || 'Failed', 'err');
  }).catch(function(e) { hideOv(); if (e.message !== 'AUTH_FAILED') toast(e.message, 'err'); });
}

function confirmDelete(tx) {
  $('confirmTitle').textContent = 'ğŸ—‘ï¸ Delete?';
  $('confirmMsg').innerHTML = 'Delete <code>' + esc(tx) + '</code>?<br><strong>This removes the transaction record. Cannot undo!</strong><br><br><span style="font-size:.8rem;color:var(--sub)">Note: Numbers must be freed first (decline the transaction) before it can be deleted.</span>';
  $('confirmYes').textContent = 'Delete'; $('confirmYes').className = 'btn-sm btn-orange';
  $('confirmYes').onclick = function() { doDelete(tx); }; $('confirmModal').classList.add('on');
}
function doDelete(tx) {
  closeConfirm(); showOv('Deleting...', '');
  adminApi('adminDeleteTransaction', { transactionId: tx }).then(function(d) {
    hideOv();
    if (d.success) { toast('ğŸ—‘ï¸ Deleted!', 'suc'); refreshAfterAction(); }
    else toast(d.error || 'Failed', 'err');
  }).catch(function(e) { hideOv(); if (e.message !== 'AUTH_FAILED') toast(e.message, 'err'); });
}

function confirmDeleteAll() {
  $('confirmTitle').textContent = 'ğŸ—‘ï¸ Delete ALL?';
  $('confirmMsg').innerHTML = 'Delete <strong>everything</strong>? All transactions and numbers will be permanently removed.<br><strong style="color:var(--err)">Cannot undo!</strong>';
  $('confirmYes').textContent = 'Delete All'; $('confirmYes').className = 'btn-sm btn-red';
  $('confirmYes').onclick = function() { doDeleteAll(); }; $('confirmModal').classList.add('on');
}
function doDeleteAll() {
  closeConfirm(); showOv('Deleting all transactions & numbers...', 'This may take a moment');
  adminApi('adminDeleteAllTransactions').then(function(d) {
    hideOv();
    if (d.success) { toast('ğŸ—‘ï¸ All deleted!', 'suc'); refreshAfterAction(); }
    else toast(d.error || 'Failed', 'err');
  }).catch(function(e) { hideOv(); if (e.message !== 'AUTH_FAILED') toast(e.message, 'err'); });
}

function refreshAfterAction() {
  loadDashboard();
  if (activeP === 'transactions') loadTransactions();
  if (activeP === 'numbers') loadNumbers();
}

// â”€â”€ SEARCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function searchNumber() {
  var q = $('searchNum').value.trim(); if (!q) return toast('Enter number.', 'err');
  q = pad6(q.replace(/\D/g, ''));
  if (!isValidNumber(q)) return toast('1st digit must be 0 or 1.', 'err');
  $('sl1').classList.add('on'); $('searchResults').style.display = 'none';
  adminApi('adminSearchNumber', { query: q }).then(function(d) {
    $('sl1').classList.remove('on'); $('searchResults').style.display = 'block';
    $('searchTitle').textContent = d.found ? 'âœ… ' + d.query + ' found' : 'âŒ Not found';
    if (d.found) {
      $('searchThead').innerHTML = '<tr><th>Number</th><th>TX</th><th>Name</th><th>Phone</th><th>GCash</th><th>Timestamp</th></tr>';
      $('searchTbody').innerHTML = d.results.map(function(r) { return '<tr class="clickable-row" onclick="openTxDetail(\'' + esc(r.transactionId) + '\')"><td class="mono">' + esc(r.number) + '</td><td>' + esc(r.transactionId) + '</td><td>' + esc(r.name) + '</td><td>' + esc(r.phone) + '</td><td>' + esc(r.gcashRef) + '</td><td>' + esc(r.timestamp) + '</td></tr>'; }).join('');
    } else { $('searchThead').innerHTML = ''; $('searchTbody').innerHTML = '<tr><td class="tbl-empty">Not sold.</td></tr>'; }
  }).catch(function(e) { $('sl1').classList.remove('on'); if (e.message !== 'AUTH_FAILED') toast('Error: ' + e.message, 'err'); });
}

function searchBuyerFn() {
  var q = $('searchBuyer').value.trim(); if (!q) return toast('Enter term.', 'err');
  $('sl2').classList.add('on'); $('searchResults').style.display = 'none';
  adminApi('adminSearchBuyer', { query: q }).then(function(d) {
    $('sl2').classList.remove('on'); $('searchResults').style.display = 'block';
    $('searchTitle').textContent = d.total + ' result(s)';
    if (d.total > 0) {
      $('searchThead').innerHTML = '<tr><th>Timestamp</th><th>TX</th><th>Name</th><th>Phone</th><th>Qty</th><th>Amt</th><th>Status</th></tr>';
      $('searchTbody').innerHTML = d.results.map(function(r) { return '<tr class="clickable-row" onclick="openTxDetail(\'' + esc(r.transactionId) + '\')"><td>' + esc(r.timestamp) + '</td><td>' + esc(r.transactionId) + '</td><td>' + esc(r.name) + '</td><td>' + esc(r.phone) + '</td><td>' + Number(r.quantity).toLocaleString() + '</td><td>â‚±' + Number(r.amount).toLocaleString() + '</td><td><span class="badge ' + statusClass(r.status) + '">' + esc(r.status) + '</span></td></tr>'; }).join('');
    } else { $('searchThead').innerHTML = ''; $('searchTbody').innerHTML = '<tr><td class="tbl-empty">None.</td></tr>'; }
  }).catch(function(e) { $('sl2').classList.remove('on'); if (e.message !== 'AUTH_FAILED') toast('Error: ' + e.message, 'err'); });
}

function searchDuplicates() {
  $('dupeBtn').disabled = true; $('sl3').classList.add('on');
  $('dupeResult').style.display = 'none'; $('searchResults').style.display = 'none';
  adminApi('adminSearchDuplicates').then(function(d) {
    $('sl3').classList.remove('on'); $('dupeBtn').disabled = false;
    if (!d || !d.success) { toast(d ? d.error : 'Failed', 'err'); return; }
    $('dupeResult').style.display = 'block';
    var summary = $('dupeSummary');
    if ((d.uniqueDuplicatedNumbers || 0) === 0) {
      summary.style.cssText = 'background:rgba(0,230,118,.08);border:1px solid rgba(0,230,118,.2);color:var(--ok)';
      summary.innerHTML = 'âœ… <strong>No duplicates!</strong><br><span style="font-size:.8rem;color:var(--sub)">All ' + (d.totalNumbers || 0).toLocaleString() + ' numbers unique.</span>';
    } else {
      summary.style.cssText = 'background:rgba(255,59,59,.08);border:1px solid rgba(255,59,59,.2);color:var(--err)';
      summary.innerHTML = 'âš ï¸ <strong>' + d.uniqueDuplicatedNumbers + ' duplicated!</strong>';
      $('searchResults').style.display = 'block';
      $('searchTitle').textContent = 'ğŸ”„ Duplicates';
      $('searchThead').innerHTML = '<tr><th>Number</th><th>TX</th><th>Name</th><th>Phone</th><th>GCash</th><th>Timestamp</th><th>#</th></tr>';
      $('searchTbody').innerHTML = (d.duplicates || []).map(function(r) { return '<tr class="clickable-row" style="background:rgba(255,59,59,.03)" onclick="openTxDetail(\'' + esc(r.transactionId || '') + '\')"><td class="mono" style="color:var(--err)">' + esc(r.number) + '</td><td style="font-size:.73rem">' + esc(r.transactionId || '') + '</td><td>' + esc(r.name || '') + '</td><td>' + esc(r.phone || '') + '</td><td>' + esc(r.gcashRef || '') + '</td><td>' + esc(r.timestamp || '') + '</td><td><span class="badge fail">Ã—' + (r.occurrences || 0) + '</span></td></tr>'; }).join('');
    }
  }).catch(function(e) { $('sl3').classList.remove('on'); $('dupeBtn').disabled = false; if (e.message !== 'AUTH_FAILED') toast(e.message, 'err'); });
}

// â”€â”€ TOOLS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addNumber() {
  var num = pad6($('addNum').value.trim().replace(/\D/g, ''));
  if (!num || !isValidNumber(num)) return toast('Invalid (1st digit 0 or 1).', 'err');
  showOv('Adding...', '');
  adminApi('adminAddNumber', { number: num, name: $('addName').value.trim(), phone: $('addPhone').value.trim() }).then(function(d) {
    hideOv();
    if (d.success) { toast('âœ… ' + d.message, 'suc'); $('addNum').value = ''; $('addName').value = ''; $('addPhone').value = ''; loadDashboard(); }
    else toast(d.error || 'Failed', 'err');
  }).catch(function(e) { hideOv(); if (e.message !== 'AUTH_FAILED') toast(e.message, 'err'); });
}

function removeNumber() {
  var num = pad6($('removeNum').value.trim().replace(/\D/g, ''));
  if (!num || !isValidNumber(num)) return toast('Invalid.', 'err');
  showOv('Removing...', '');
  adminApi('adminRemoveNumber', { number: num }).then(function(d) {
    hideOv();
    if (d.success) { toast('âœ… ' + d.message, 'suc'); $('removeNum').value = ''; loadDashboard(); }
    else toast(d.error || 'Failed', 'err');
  }).catch(function(e) { hideOv(); if (e.message !== 'AUTH_FAILED') toast(e.message, 'err'); });
}

// â”€â”€ SETTINGS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadSettingsFn() {
  adminApi('adminInit').then(function(d) {
    if (d && d.success && d.settings) applySettingsToForm(d.settings);
  }).catch(function() {});
}

function applySettingsToForm(s) {
  $('setGcashName').value = s.gcash_name || '';
  $('setGcashNum').value = s.gcash_number || '';
  $('setLotteryName').value = s.lottery_name || '';
  $('setDrawDate').value = s.draw_date || '';
  $('setPrice').value = s.price_per_number || '1';
  $('setMinQty').value = s.min_quantity || '100';
  $('setMaxQty').value = s.max_quantity || '10000';
  $('setAnnouncement').value = s.announcement || '';
  $('setMaintenance').value = s.maintenance_mode || 'false';
}

function saveSettings() {
  var np = $('setNewPass').value, np2 = $('setNewPass2').value;
  if (np && np.length < 6) return toast('Min 6 chars.', 'err');
  if (np && np !== np2) return toast("Passwords don't match.", 'err');
  showOv('Saving...', '');
  var p = {
    gcash_name: $('setGcashName').value.trim(), gcash_number: $('setGcashNum').value.trim(),
    lottery_name: $('setLotteryName').value.trim(), draw_date: $('setDrawDate').value,
    price_per_number: $('setPrice').value, min_quantity: $('setMinQty').value,
    max_quantity: $('setMaxQty').value, announcement: $('setAnnouncement').value.trim(),
    maintenance_mode: $('setMaintenance').value
  };
  if (np) p.new_password = np;
  adminApi('adminUpdateSettings', p).then(function(d) {
    hideOv();
    if (d.success) { toast('âœ… Saved!', 'suc'); $('setNewPass').value = ''; $('setNewPass2').value = ''; if (np) { toast('Password changed. Logging out...', 'warn'); setTimeout(doLogout, 2000); } }
    else toast(d.error || 'Failed', 'err');
  }).catch(function(e) { hideOv(); if (e.message !== 'AUTH_FAILED') toast('Error: ' + e.message, 'err'); });
}

// â”€â”€ EXPORT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function exportData(type) {
  showOv('Exporting...', '');
  adminApi('adminExportData', { type: type }).then(function(d) {
    hideOv();
    if (!d.success) return toast(d.error || 'Failed', 'err');
    var csv = d.headers.join(',') + '\n';
    d.data.forEach(function(r) { csv += r.map(function(c) { return '"' + String(c).replace(/"/g, '""') + '"'; }).join(',') + '\n'; });
    var a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv' }));
    a.download = 'PisoPalaro-' + type + '-' + new Date().toISOString().slice(0, 10) + '.csv';
    a.click(); toast('Exported ' + (d.total || 0) + ' rows!', 'suc');
  }).catch(function(e) { hideOv(); if (e.message !== 'AUTH_FAILED') toast('Error: ' + e.message, 'err'); });
}

// â”€â”€ AUTO REFRESH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startAutoRefresh() {
  if (_art) clearInterval(_art);
  _art = setInterval(function() {
    if (!TOKEN) return;
    if (activeP === 'dashboard') {
      adminApi('adminDashboard').then(function(d) {
        if (d && d.success) renderDashboard(d);
      }).catch(function() {});
    }
  }, 15000);
}

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('DOMContentLoaded', function() {
  detectMode();

  if (IS_ADMIN_MODE) {
    $('loginPass').addEventListener('keydown', function(e) { if (e.key === 'Enter') doLogin(); });
    $('loginUser').addEventListener('keydown', function(e) { if (e.key === 'Enter') $('loginPass').focus(); });
  } else {
    setTodayDate();
    $('dP').textContent = GCASH_NUMBER;
    $('dN').textContent = GCASH_NAME;

    var ni = $('fN');
    ni.maxLength = MAX_NAME_LEN;
    ni.addEventListener('input', function() {
      var v = ni.value.replace(/[<>"'`;{}()\\]/g, '');
      if (v !== ni.value) ni.value = v;
      if (ni.value.length > MAX_NAME_LEN) ni.value = ni.value.substring(0, MAX_NAME_LEN);
    });

    $('fP').addEventListener('input', function() { this.value = getDigitsOnly(this.value).substring(0, 11); updatePhoneStatus(); });
    $('fP').addEventListener('blur', updatePhoneStatus);
    $('fQ').addEventListener('input', calc);
    $('fQ').addEventListener('blur', function() {
      var v = parseInt(this.value);
      if (!isNaN(v) && v < MIN_QTY && this.value !== '') { this.value = MIN_QTY; toast('Min ' + MIN_QTY, 'warn'); }
      if (!isNaN(v) && v > MAX_QTY) { this.value = MAX_QTY; toast('Max ' + MAX_QTY.toLocaleString(), 'warn'); }
      calc();
    });
    $('fR').addEventListener('input', function() { this.value = getDigitsOnly(this.value).substring(0, 13); });

    checkConnection();
    setInterval(setTodayDate, 60000);
  }

  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') { closeConfirm(); closeDetail(); }
    if (e.key === 'Enter' && IS_ADMIN_MODE) {
      if (document.activeElement === $('searchNum')) searchNumber();
      if (document.activeElement === $('searchBuyer')) searchBuyerFn();
    }
  });

  $('confirmModal').addEventListener('click', function(e) { if (e.target === $('confirmModal')) closeConfirm(); });
  $('detailModal').addEventListener('click', function(e) { if (e.target === $('detailModal')) closeDetail(); });
});
</script>
</body>
</html>
